# What this file is:
# CI workflow that validates PRs and branches: lint/docs checks, token validation, Storybook build smoke, and tests.
# Edit by: Eng Lead or Infra maintainer. Update when CI steps or node versions change.
# When to update (example): add a new job when token schema validation is enhanced.
# Who must approve changes: Eng Lead and Infra team.

name: CI â€” validate

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - '**'    # run on branch pushes as well (adjust if noisy)

jobs:
  checkout-and-setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      node-version: ${{ steps.node-version.outputs.node-version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        id: node-version
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies (if package.json exists)
        run: |
          if [ -f package.json ]; then
            npm ci
          else
            echo "No package.json present; skipping npm install"
          fi

  lint-and-tests:
    name: Lint & Tests
    runs-on: ubuntu-latest
    needs: checkout-and-setup
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install deps
        run: |
          if [ -f package.json ]; then npm ci; else echo "No package.json"; fi

      - name: Run lint (docs placeholder)
        run: |
          if npm run | grep -q "lint"; then npm run lint || echo "lint failed (non-blocking for template)"; else echo "no lint script"; fi

      - name: Run tests
        run: |
          if npm run | grep -q "test"; then npm test || (echo "Tests failed"; exit 1); else echo "no tests configured"; fi

  token-validate:
    name: Token validation
    runs-on: ubuntu-latest
    needs: checkout-and-setup
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install deps
        run: |
          if [ -f package.json ]; then npm ci; else echo "No package.json"; fi

      - name: Run token validation script
        run: |
          if [ -f scripts/token-validate.js ]; then node scripts/token-validate.js; else echo "No token validation script present; skipping"; fi

  storybook-smoke:
    name: Storybook smoke build
    runs-on: ubuntu-latest
    needs: checkout-and-setup
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install deps
        run: |
          if [ -f package.json ]; then npm ci; else echo "No package.json"; fi

      - name: Build Storybook (smoke)
        run: |
          if [ -f scripts/build-storybook.js ]; then node scripts/build-storybook.js; else echo "No storybook builder script; skipping"; fi

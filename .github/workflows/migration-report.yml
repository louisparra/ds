# CI workflow to run migration previews and post a PR comment.
# Rewritten to avoid YAML parsing problems (no inline heredocs).
#
# Who should edit it:
# Infra / Token Owner / Design System Lead.
#
# When to update:
# When reporting behaviour or migration script changes.
#
# Approvals:
# Engineering Lead & Token Owner.

name: Migration report — tokens

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  migration-report:
    name: Generate migration reports and comment on PR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Find migration JSON files
        id: find_migrations
        run: |
          #!/usr/bin/env bash
          set -euo pipefail
          shopt -s nullglob
          files=(tokens/migrations/*.json)
          if [ "${#files[@]}" -eq 0 ]; then
            echo "found=false" >> "$GITHUB_OUTPUT"
            echo "files=" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          # Join files with space; this is safe because paths don't contain newlines
          files_str="${files[*]}"
          echo "found=true" >> "$GITHUB_OUTPUT"
          echo "files=${files_str}" >> "$GITHUB_OUTPUT"

      - name: Generate aggregated migration report
        id: generate
        if: steps.find_migrations.outputs.found == 'true'
        run: |
          #!/usr/bin/env bash
          set -euo pipefail

          # Get file list from previous step (space-separated)
          FILES="${{ steps.find_migrations.outputs.files }}"
          REPORT_FILE=./migration-report.md

          echo "# Migration preview report" > "${REPORT_FILE}"
          echo "_This comment is autogenerated by CI — preview only._" >> "${REPORT_FILE}"
          echo "" >> "${REPORT_FILE}"

          for f in ${FILES}; do
            if [ -f "${f}" ]; then
              echo "## Migration: ${f}" >> "${REPORT_FILE}"
              echo '```' >> "${REPORT_FILE}"
              node scripts/report-migrations.js --file "${f}" 2>&1 | sed 's/^/    /' >> "${REPORT_FILE}" || true
              echo '```' >> "${REPORT_FILE}"
              echo "" >> "${REPORT_FILE}"
            else
              echo "## Migration: ${f}" >> "${REPORT_FILE}"
              echo "```\n    WARNING: file not found: ${f}\n```" >> "${REPORT_FILE}"
              echo "" >> "${REPORT_FILE}"
            fi
          done

          # Export the full report as a workflow output (multi-line)
          echo "report<<'EOF'" >> "$GITHUB_OUTPUT"
          cat "${REPORT_FILE}" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Create or update PR comment with migration report
        if: steps.find_migrations.outputs.found == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.generate.outputs.report }}

      - name: No migrations found — post note (optional)
        if: steps.find_migrations.outputs.found != 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            No migration JSON files were found under `tokens/migrations/` in this branch.
            If you added a migration, ensure the file is committed to `tokens/migrations/*.json`.

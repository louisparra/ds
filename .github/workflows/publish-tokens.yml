# What this file is:
# CI workflow that builds design tokens, produces a package tarball (npm pack),
# uploads it as a workflow artifact, and optionally publishes the package to an npm-style registry.
#
# Who should edit it:
# Token Owner, Infra, or Release Engineer.
#
# When to update (example):
# Update when package paths change, publishing policy changes, or registry auth method changes.
#
# Who must approve changes:
# Token Owner & Engineering Lead.

name: Tokens â€” build, pack & optional publish

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      publish:
        description: 'Publish package to registry (requires NPM_TOKEN secret). Set to "true" to publish. Default: false'
        required: false
        default: 'false'

permissions:
  contents: read
  pull-requests: write

jobs:
  build-and-pack:
    name: Build tokens and pack
    runs-on: ubuntu-latest
    outputs:
      packed-file: ${{ steps.pack.outputs.tgz }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Build tokens (Style Dictionary)
        run: |
          # Build tokens and run smoke checks
          node scripts/build-tokens.js

      - name: Pack tokens package (npm pack)
        id: pack
        working-directory: packages/tokens
        run: |
          set -euo pipefail
          # Ensure package version is not placeholder before packing in production; we still allow packing dev version.
          TGZ=$(npm pack)
          echo "packed=$TGZ" >> "$GITHUB_OUTPUT"
          echo "::notice title=Packed::Created package tarball: $TGZ"
        # expose outputs via ${{ steps.pack.outputs.packed-file }} (.github Actions set above attempts to get it)

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: design-tokens-package
          path: packages/tokens/*.tgz

  publish:
    name: Publish package (optional)
    runs-on: ubuntu-latest
    needs: build-and-pack
    if: >
      (github.event_name == 'workflow_dispatch' && github.event.inputs.publish == 'true')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Ensure NPM token is available
        run: |
          if [ -z "${{ secrets.NPM_TOKEN }}" ]; then
            echo "NPM_TOKEN secret is not set. Cannot publish."
            exit 2
          fi

      - name: Configure npm auth for registry
        env:
          NPM_REGISTRY_URL: ${{ secrets.NPM_REGISTRY_URL }}
        run: |
          # Determine registry URL and host. If NPM_REGISTRY_URL secret is not set, default to registry.npmjs.org
          REGISTRY_URL="${NPM_REGISTRY_URL:-https://registry.npmjs.org/}"
          # Extract host (e.g., registry.npmjs.org)
          REGISTRY_HOST=$(echo "$REGISTRY_URL" | sed -E 's~https?://~~' | sed -E 's~/.*$~~')
          echo "Using registry: $REGISTRY_URL (host: $REGISTRY_HOST)"
          # Write token to .npmrc in workspace so npm publish picks it up
          echo "//${REGISTRY_HOST}/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
          echo "Created ~/.npmrc with auth token for $REGISTRY_HOST"

      - name: Publish package to registry
        working-directory: packages/tokens
        env:
          NPM_REGISTRY_URL: ${{ secrets.NPM_REGISTRY_URL }}
        run: |
          set -euo pipefail
          REGISTRY_URL="${NPM_REGISTRY_URL:-https://registry.npmjs.org/}"
          echo "Publishing package to $REGISTRY_URL"
          # (optional) ensure package version is valid semver and not a dev placeholder
          PACKAGE_VERSION=$(node -e "console.log(require('./package.json').version)")
          echo "Package version: $PACKAGE_VERSION"
          # Publish. Access setting may be required for scoped packages; change --access when needed.
          npm publish --registry "$REGISTRY_URL" || (echo "npm publish failed" && exit 1)
          echo "::notice title=Publish::Package published to $REGISTRY_URL"

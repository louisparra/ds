/*
What this file is:
Minimal Dart theme generator for Flutter (lib/design_tokens.dart) from tokens/tokens.json.

Who should edit it:
Token Owner or Mobile engineer.

When to update (example):
Change naming conventions or add more token categories to export.

Who must approve changes:
Token Owner & Engineering Lead.

Usage:
  node scripts/generate-dart-theme.js
  # writes packages/tokens/dist/dart/lib/design_tokens.dart

Expected output:
  Dart file exporting color and spacing constants:
  class DesignTokens { static const Color colorBrandPrimary = Color(0xFF0A84FF); static const double spacingScale4 = 16.0; }
*/

const fs = require('fs');
const path = require('path');

const TOKENS_PATH = path.resolve(process.cwd(), 'tokens', 'tokens.json');
const OUT_DIR = path.resolve(process.cwd(), 'packages', 'tokens', 'dist', 'dart', 'lib');
const OUT_FILE = path.join(OUT_DIR, 'design_tokens.dart');

if (!fs.existsSync(TOKENS_PATH)) {
  console.error('tokens/tokens.json not found. Run from repo root.');
  process.exit(2);
}

function isLeafToken(obj) {
  return obj && typeof obj === 'object' && Object.prototype.hasOwnProperty.call(obj, 'value');
}

function flatten(obj, prefix = []) {
  const entries = [];
  for (const key of Object.keys(obj || {})) {
    const v = obj[key];
    const p = prefix.concat([key]);
    if (isLeafToken(v)) {
      entries.push({ path: p.join('.'), token: v });
    } else if (typeof v === 'object') {
      entries.push(...flatten(v, p));
    }
  }
  return entries;
}

function dartConstName(dotPath) {
  // convert to camelCase and prefix type
  const parts = dotPath.split('.');
  const camel = parts
    .map((p, i) => (i === 0 ? p.toLowerCase() : p.charAt(0).toUpperCase() + p.slice(1)))
    .join('');
  // avoid starting with number
  return camel.replace(/[^a-zA-Z0-9_]/g, '_');
}

function hexToDartColor(hex) {
  if (!hex) return null;
  const h = hex.trim().replace('#', '');
  if (h.length === 3) {
    const r = h[0] + h[0];
    const g = h[1] + h[1];
    const b = h[2] + h[2];
    return `0xFF${r}${g}${b}`.toUpperCase();
  } else if (h.length === 6) {
    return `0xFF${h.toUpperCase()}`;
  }
  return null;
}

try {
  const tokens = JSON.parse(fs.readFileSync(TOKENS_PATH, 'utf8'));
  const leaves = flatten(tokens);

  if (!fs.existsSync(OUT_DIR)) fs.mkdirSync(OUT_DIR, { recursive: true });

  const lines = [];
  lines.push('// GENERATED FILE - DO NOT EDIT');
  lines.push('// Generated by scripts/generate-dart-theme.js');
  lines.push('');
  lines.push("import 'package:flutter/material.dart';");
  lines.push('');
  lines.push('class DesignTokens {');
  lines.push('  DesignTokens._();');
  lines.push('');

  for (const e of leaves) {
    const typeHint = (e.token.type || '').toLowerCase();
    const name = dartConstName(e.path);
    const v = e.token.value;
    if (typeHint === 'color' || (typeof v === 'string' && v.trim().startsWith('#'))) {
      const dartColor = hexToDartColor(v);
      if (!dartColor) {
        continue;
      }
      lines.push(`  static const Color ${name} = Color(${dartColor});`);
    } else if (
      typeHint.indexOf('spacing') !== -1 ||
      String(v).endsWith('px') ||
      typeof v === 'number'
    ) {
      // try to parse numeric value in px -> convert to double
      let num = null;
      if (typeof v === 'number') num = v;
      else if (typeof v === 'string' && v.trim().endsWith('px'))
        num = parseFloat(v.trim().replace('px', ''));
      else {
        // skip non-numeric spacing
      }
      if (num !== null && !Number.isNaN(num)) {
        lines.push(`  static const double ${name} = ${parseFloat(num).toFixed(1)};`);
      }
    } else {
      // other token types skipped in minimal generator
    }
  }

  lines.push('');
  lines.push('}');

  fs.writeFileSync(OUT_FILE, lines.join('\n') + '\n', 'utf8');
  console.log('Wrote', OUT_FILE);
  process.exit(0);
} catch (err) {
  console.error('ERROR generating Dart theme:', err && err.message ? err.message : err);
  process.exit(1);
}
